name: CI (Python & Rust)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # --- JOB 1: RUST CHECKS ---
  rust-checks:
    name: Rust (Clippy & Tests)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Rust Format Check
        run: cargo fmt --all -- --check

      - name: Rust Clippy (Linting)
        run: cargo clippy -- -D warnings

      - name: Run Rust Core Tests
        run: cargo test

  # --- JOB 2: PYTHON CHECKS ---
  python-checks:
    name: Python (Ruff & Pytest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Necesitamos Rust aquí para que Maturin pueda compilar la VM
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Build Tools
        run: |
          python -m pip install --upgrade pip
          pip install maturin ruff pytest tornado asyncpg redis

      - name: Build Rust Extension
        run: |
          # Esto compila el Rust core e instala el paquete en el venv de la Action
          maturin develop

      - name: Python Linting (Ruff)
        run: ruff check .

      - name: Run Python API Tests
        run: |
          # Aseguramos que pytest vea el código
          export PYTHONPATH=$PYTHONPATH:.
          pytest tests/

  # --- JOB 3: BUILD INTEGRATION ---
  build-integration:
    name: Build & Bindings Check
    runs-on: ubuntu-latest
    needs: [rust-checks, python-checks]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust & Python
        uses: dtolnay/rust-toolchain@stable
        
      - name: Install Maturin
        run: pip install maturin

      - name: Verify Maturin Build (Python-Rust Bridge)
        run: maturin build
